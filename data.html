<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Data Guest Comments</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    body { padding: 20px; }
    table td { vertical-align: middle; }
    .table-success { background-color: #d1e7dd !important; }

    #saveBtn {
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }
    #saveBtn.active {
      opacity: 1;
      pointer-events: auto;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h2 class="mb-3">Guest Comments</h2>

    <!-- Filter -->
    <div class="row mb-3">
      <div class="col-auto">
        <label for="filterStart" class="form-label">Tanggal Mulai:</label>
        <input type="date" id="filterStart" class="form-control"/>
      </div>
      <div class="col-auto">
        <label for="filterEnd" class="form-label">Tanggal Akhir:</label>
        <input type="date" id="filterEnd" class="form-control"/>
      </div>
      <div class="col-auto d-flex align-items-end">
        <button id="filterBtn" class="btn btn-primary me-2">Filter</button>
        <button id="resetBtn" class="btn btn-secondary me-2">Reset</button>
        <button id="exportBtn" class="btn btn-success">Export Excel</button>
      </div>
    </div>

    <!-- Tabel Data -->
    <div class="table-responsive">
      <table id="dataTable" class="table table-bordered table-hover table-sm align-middle">
        <thead class="table-light">
          <tr>
            <th style="text-align:center;">
              <input type="checkbox" id="selectAll"/>
            </th>
            <th>Tanggal</th>
            <th>Jam</th>
            <th>No Meja</th>
            <th>Nama Tamu</th>
            <th>Asal</th>
            <th>Media Source</th>
            <th>Media Other</th>
            <th>Event Type</th>
            <th>Service Other</th>
            <th>Age Range</th>
            <th>Food Quality</th>
            <th>Beverage Quality</th>
            <th>Serving Speed</th>
            <th>Service Rating</th>
            <th>Cleanliness</th>
            <th>Ambience</th>
            <th>Price Rating</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Tombol Simpan -->
    <div class="mt-3">
      <button id="saveBtn" class="btn btn-warning">Simpan</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1055">
    <div id="saveToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body">
          âœ… Data berhasil disimpan
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Data.js berisi deklarasi saveBtn, tableBody, dll -->
  <script src="data.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function checkSaveButtonState() {
      if (!window.allData) return;
      const changed = window.allData.some(row => {
        return Boolean(row._checked) !== Boolean(row._saved);
      });
      if (changed) {
        saveBtn.classList.add("active");
      } else {
        saveBtn.classList.remove("active");
      }
    }

    // Observer untuk deteksi checkbox
    const observer = new MutationObserver(() => {
      tableBody.querySelectorAll("input[type=checkbox]").forEach(cb => {
        cb.addEventListener("change", checkSaveButtonState);
      });
      checkSaveButtonState();
    });
    observer.observe(tableBody, { childList: true, subtree: true });

    // Hook renderTable
    const oldRender = window.renderTable;
    window.renderTable = function(data) {
      oldRender(data);
      tableBody.querySelectorAll("input[type=checkbox]").forEach(cb => {
        cb.addEventListener("change", checkSaveButtonState);
      });
      checkSaveButtonState();
    };

    // Reset tombol setelah Simpan
    saveBtn.addEventListener("click", () => {
      if (window.allData) {
        window.allData.forEach(row => {
          row._saved = row._checked;
        });
      }
      checkSaveButtonState();

      // Tampilkan toast
      const toastEl = document.getElementById("saveToast");
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
    });
  </script>
</body>
</html>
